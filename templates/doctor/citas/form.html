{% extends 'home.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
{% include 'fragments/messages.html' %}

<!-- ======================= -->
<!--  Calendar + Modal Form  -->
<!-- ======================= -->

<style>
  /* ---------- Global reset & base font ---------- */
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

  /* ---------- Calendar shell ---------- */
  .calendar-container {
    max-width: 1200px;
    margin: 0 auto;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }
  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 30px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
  }
  .month-year { font-size: 24px; font-weight: 600; color: #1e293b; }
  .nav-buttons { display: flex; gap: 10px; }
  .nav-btn {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 8px 12px;
    cursor: pointer;
    transition: .2s;
    font-size: 14px;
    color: #64748b;
  }
  .nav-btn:hover { background: #f1f5f9; border-color: #cbd5e1; }
  .add-event-btn {
    background: #6366f1; color: #fff; border: none; border-radius: 8px;
    padding: 10px 20px; cursor: pointer; font-weight: 500; transition: .2s;
  }
  .add-event-btn:hover { background: #4f46e5; }

  /* ---------- Grid ---------- */
  .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
  .day-header {
    padding: 15px 10px; text-align: center; font-weight: 600; color: #64748b;
    background: #f8fafc; border-bottom: 1px solid #e2e8f0; font-size: 14px;
  }
  .day-cell {
    min-height: 120px; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;
    padding: 8px; cursor: pointer; position: relative; background: #fff; transition: .2s;
  }
  .day-cell:hover { background: #f8fafc; }
  .day-cell.other-month { background: #f8fafc; color: #cbd5e1; }
  .day-cell.selected { background: #eff6ff; border-color: #3b82f6; }
  .day-number { font-weight: 500; margin-bottom: 5px; color: #1e293b; }
  .day-cell.other-month .day-number { color: #cbd5e1; }

  /* ---------- Event pills ---------- */
  .event {
    background: #3b82f6; color: #fff; padding: 2px 6px; border-radius: 4px;
    font-size: 11px; margin-bottom: 2px; cursor: pointer; white-space: nowrap;
    overflow: hidden; text-overflow: ellipsis;
  }
  .event.appointment { background: #10b981; }
  .event.meeting     { background: #f59e0b; }
  .event.personal    { background: #ef4444; }

  /* ---------- Modal ---------- */
  .time-picker-modal {
    position: fixed; inset: 0; background: rgba(0, 0, 0, .45);
    display: none; justify-content: center; align-items: center; z-index: 1000;
  }
  .modal-content {
    background: #fff; border-radius: 16px; padding: 30px; width: 90%; max-width: 500px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, .2);
  }
  .modal-title   { font-size: 20px; font-weight: 600; color: #1e293b; margin-bottom: 5px; }
  .selected-date { color: #6366f1; font-size: 14px; margin-bottom: 20px; }
  .time-slots { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 24px; }
  .time-slot {
    padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; text-align: center;
    cursor: pointer; transition: .2s; font-weight: 500;
  }
  .time-slot:hover   { border-color: #6366f1; background: #f0f9ff; }
  .time-slot.selected{ background: #6366f1; color: #fff; border-color: #4f46e5; }
  .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px; }
  .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: .2s; }
  .btn-secondary { background: #f1f5f9; color: #64748b; }
  .btn-secondary:hover { background: #e2e8f0; }
  .btn-primary { background: #6366f1; color: #fff; }
  .btn-primary:hover { background: #4f46e5; }

  /* ---------- Responsive ---------- */
  @media (max-width: 768px) {
    .calendar-header { flex-direction: column; gap: 15px; text-align: center; }
    .day-cell { min-height: 80px; }
    .time-slots { grid-template-columns: repeat(2, 1fr); }
  }
</style>

<!-- =================  Calendario  ================= -->
<section class="py-10 md:py-14">
  <div class="calendar-container" data-aos="fade-up" data-aos-delay="200">
    <!-- Header -->
    <div class="calendar-header">
      <div class="nav-buttons">
        <button class="nav-btn" id="prevMonth">‚Äπ Anterior</button>
        <button class="nav-btn" id="nextMonth">Siguiente ‚Ä∫</button>
      </div>
      <div class="month-year" id="currentMonth"></div>
      <button class="add-event-btn" onclick="alert('Selecciona una fecha en el calendario primero üôÇ')">+ Agregar cita</button>
    </div>

    <!-- Headers de la semana -->
    <div class="calendar-grid">
      <div class="day-header">Lun</div><div class="day-header">Mar</div><div class="day-header">Mi√©</div>
      <div class="day-header">Jue</div><div class="day-header">Vie</div><div class="day-header">S√°b</div><div class="day-header">Dom</div>
    </div>

    <!-- D√≠as din√°micos -->
    <div class="calendar-grid" id="calendarDays"></div>
  </div>
</section>

<!-- ==================== Modal / Formulario ==================== -->
<div class="time-picker-modal" id="timePickerModal">
  <div class="modal-content">
    <div class="modal-header text-center mb-6">
      <div class="modal-title">Agendar Cita</div>
      <div class="selected-date" id="selectedDateText"></div>
    </div>

    <!-- 1) Slots de hora  -->
    <div class="time-slots" id="timeSlots"></div>

    <!-- 2) Formulario de la cita  -->
    <form method="post" id="citaForm" class="space-y-6 mt-4">
      {% csrf_token %}
      <!-- Hidden date/time -->
      <input type="hidden" id="modalHiddenDate" name="fecha">
      <input type="hidden" id="modalHiddenTime" name="hora_cita">

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="id_paciente" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-user mr-2 text-emerald-600"></i>Paciente</label>
          {{ form.paciente }}
          {% if form.paciente.errors %}<p class="text-red-500 text-xs mt-1">{{ form.paciente.errors }}</p>{% endif %}
        </div>
        <div>
          <label for="id_estado" class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-check-circle mr-2 text-emerald-600"></i>Estado</label>
          {{ form.estado }}
          {% if form.estado.errors %}<p class="text-red-500 text-xs mt-1">{{ form.estado.errors }}</p>{% endif %}
        </div>
      </div>
      <!-- Botones -->
      <div class="modal-buttons pt-2">
        
        <button type="submit" class="btn btn-primary" id="confirmBtn" disabled>Guardar Cita</button>
      </div>
    </form>
  </div>
</div>

<!-- ==================== Script ==================== -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ------- Variables y datos ------- */
    let currentDate   = new Date();
    let selectedDate  = null;
    let selectedTime  = null;

    const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    const availableHours = ['09:00','09:30','10:00','10:30','11:00','11:30','14:00','14:30','15:00','15:30','16:00','16:30','17:00'];
    const events = {}; // Eventos existentes (rellenar desde backend si lo deseas)

    /* ------- Elementos del DOM ------- */
    const monthYearEl   = document.getElementById('currentMonth');
    const calendarDays  = document.getElementById('calendarDays');
    const modal         = document.getElementById('timePickerModal');
    const selectedDateTxt = document.getElementById('selectedDateText');
    const timeSlotsCont = document.getElementById('timeSlots');
    const confirmBtn    = document.getElementById('confirmBtn');

    /* ------- Funciones del calendario ------- */
    function renderCalendar() {
      const y = currentDate.getFullYear();
      const m = currentDate.getMonth();
      monthYearEl.textContent = `${monthNames[m]} ${y}`;
      calendarDays.innerHTML  = '';

      const firstDay = new Date(y, m, 1);
      const lastDay  = new Date(y, m + 1, 0);
      const daysInMonth = lastDay.getDate();
      let startDay = firstDay.getDay();
      startDay = startDay === 0 ? 6 : startDay - 1; // Lunes = 0

      const allDays = [];
      const prevLastDay = new Date(y, m, 0);
      for (let i = startDay - 1; i >= 0; i--) allDays.push({ day: prevLastDay.getDate() - i, other: true });
      for (let d = 1; d <= daysInMonth; d++) allDays.push({ day: d, other: false });
      for (let d = 1; allDays.length < 42; d++) allDays.push({ day: d, other: true });

      allDays.forEach(info => {
        const cell = document.createElement('div');
        cell.className = 'day-cell' + (info.other ? ' other-month' : '');
        const num = document.createElement('div'); num.className = 'day-number'; num.textContent = info.day; cell.appendChild(num);

        if (!info.other) {
          const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(info.day).padStart(2,'0')}`;
          if (events[dateStr]) events[dateStr].forEach(ev => {
            const pill = document.createElement('div'); pill.className = `event ${ev.type}`; pill.textContent = `${ev.time} ¬∑ ${ev.title}`; cell.appendChild(pill);
          });
          cell.addEventListener('click', () => selectDate(info.day));
        }
        calendarDays.appendChild(cell);
      });
    }

    /* ------- Seleccionar fecha/time ------- */
    function selectDate(day) {
      const y = currentDate.getFullYear();
      const m = currentDate.getMonth();
      const chosen = new Date(y, m, day);
      const today  = new Date(); today.setHours(0,0,0,0);
      if (chosen < today) { alert('No puedes agendar citas en fechas pasadas'); return; }
      selectedDate = chosen;

      document.querySelectorAll('.day-cell').forEach(c => c.classList.remove('selected'));
      event.target.closest('.day-cell').classList.add('selected');

      showModal();
    }

    function showModal() {
      selectedDateTxt.textContent = selectedDate.toLocaleDateString('es-ES', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
      document.getElementById('modalHiddenDate').value = selectedDate.toISOString().split('T')[0];

      timeSlotsCont.innerHTML = '';
      availableHours.forEach(h => {
        const slot = document.createElement('div'); slot.className = 'time-slot'; slot.textContent = h;
        slot.addEventListener('click', () => selectTime(h, slot)); timeSlotsCont.appendChild(slot);
      });
      confirmBtn.disabled = true;
      modal.style.display = 'flex';
    }

    function closeModal() { modal.style.display = 'none'; selectedTime = null; }

    function selectTime(time, el) {
      document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
      el.classList.add('selected');
      selectedTime = time;
      document.getElementById('modalHiddenTime').value = time;
      confirmBtn.disabled = false;
    }

    /* ------- Navegaci√≥n de meses ------- */
    document.getElementById('prevMonth').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
    document.getElementById('nextMonth').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });

    /* ------- Cerrar modal al click outside ------- */
    modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

    renderCalendar();
  });
</script>
{% endblock %}











{% extends 'home.html' %}
{% load static %}
<title>{% block title %}Registrar Pago{% endblock %}</title>

{% block content %}
<section class="mt-4 bg-white dark:bg-principal">
  <div class="container mx-auto max-w-3xl px-4 py-8 rounded-xl shadow-lg">

    <!-- Título -->
    <h2 class="text-3xl md:text-4xl font-bold text-gray-800 bg-sky-600 py-3 px-6 rounded-xl shadow text-center uppercase mb-6">
      Registrar Pago
    </h2>

    <!-- Botón volver -->
    <div class="mb-6">
      <a href="{% url 'doctor:pago_list' %}"
         class="bg-sky-100 hover:bg-sky-200 text-sky-800 px-4 py-2 rounded-full shadow transition-colors duration-200 inline-flex items-center">
        <i class="fa-solid fa-arrow-left mr-2"></i> Volver a la lista de pagos
      </a>
    </div>

    <!-- Formulario -->
    <form id="pagoForm" enctype="multipart/form-data" class="space-y-6">
      {% csrf_token %}

      <div>
        <label for="id_atencion" class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Atención relacionada</label>
        {{ form.atencion }}
      </div>

      <div>
        <label for="id_metodo_pago" class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Método de pago</label>
        {{ form.metodo_pago }}
      </div>

      <div>
        <label for="id_monto_total" class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Monto total</label>
        {{ form.monto_total }}
      </div>

      <div>
        <label for="id_estado" class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Estado</label>
        {{ form.estado }}
      </div>

      <div>
        <label for="id_fecha_pago" class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Fecha de pago</label>
        {{ form.fecha_pago }}
      </div>

      <div>
        <label for="id_nombre_pagador" class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Nombre del pagador</label>
        {{ form.nombre_pagador }}
      </div>

      <div>
        <label for="id_referencia_externa" class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Referencia externa</label>
        {{ form.referencia_externa }}
      </div>

      <div>
        <label for="id_evidencia_pago" class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Comprobante / evidencia</label>
        {{ form.evidencia_pago }}
      </div>

      <div>
        <label for="id_observaciones" class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Observaciones</label>
        {{ form.observaciones }}
      </div>

      <div class="flex items-center">
        {{ form.activo }}
        <label for="id_activo" class="ml-2 text-sm text-gray-700 dark:text-gray-200">Activo</label>
      </div>

      <!-- Botón Guardar -->
      <button type="submit"
              class="w-full bg-sky-600 hover:bg-sky-700 text-white py-2 px-4 rounded-full shadow transition duration-200">
        <i class="fa-solid fa-floppy-disk mr-2"></i> Guardar Pago
      </button>
    </form>

    <!-- Mensajes -->
    <div id="pagoMsg" class="mt-4 text-center"></div>

    <!-- PayPal -->
    <div id="paypal-button-container" class="mt-8"></div>
    <div id="result-message" class="mt-4 text-center"></div>
  </div>
</section>

<!-- Scripts -->
<script>
document.getElementById('pagoForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const url = form.getAttribute('action') || window.location.href;
    const formData = new FormData(form);

    const response = await fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
    });

    const msgDiv = document.getElementById('pagoMsg');
    if (response.ok) {
        msgDiv.textContent = 'Pago registrado correctamente.';
        msgDiv.className = 'mt-4 text-green-600 text-center';
        form.reset();
    } else {
        const data = await response.json().catch(() => ({}));
        msgDiv.textContent = data.error || 'Error al registrar el pago.';
        msgDiv.className = 'mt-4 text-red-600 text-center';
    }
});
</script>

<script src="https://www.paypal.com/sdk/js?client-id=AcbsbRcDmtknpJC2JJZ2upQ2DdkcihDaYw2Ckv69TxALnpnvzD1ug_O6foGXwry-soGMZkdXVOtB15io"
        data-sdk-integration-source="developer-studio"></script>

<script type="module">
const paypalButtons = window.paypal.Buttons({
    style: {
        shape: "rect",
        layout: "vertical",
        color: "gold",
        label: "paypal",
    },
    async createOrder() {
        const montoInput = document.querySelector('#id_monto_total');
        const monto = montoInput ? parseFloat(montoInput.value) || 0 : 0;
        try {
            const response = await fetch("/api/order/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ amount: monto }),
            });
            const orderData = await response.json();
            if (orderData.id) return orderData.id;
            throw new Error(orderData?.details?.[0]?.description || JSON.stringify(orderData));
        } catch (error) {
            console.error(error);
        }
    },
    async onApprove(data, actions) {
        try {
            const response = await fetch(`/api/orders/${data.orderID}/capture`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
            });
            const orderData = await response.json();
            const errorDetail = orderData?.details?.[0];
            if (errorDetail?.issue === "INSTRUMENT_DECLINED") return actions.restart();
            if (errorDetail) throw new Error(errorDetail.description);
            const transaction = orderData?.purchase_units?.[0]?.payments?.captures?.[0];
            resultMessage(`Transacción ${transaction.status}: ${transaction.id}`);
            console.log("Resultado:", orderData);
        } catch (error) {
            console.error(error);
            resultMessage(`Error en la transacción<br><br>${error}`);
        }
    },
});
paypalButtons.render("#paypal-button-container");

function resultMessage(message) {
    document.querySelector("#result-message").innerHTML = message;
}
</script>
{% endblock %}
